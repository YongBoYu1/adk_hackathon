<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Audio Stream Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group input, .control-group select, .control-group button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .control-group input, .control-group select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .status {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.connected {
            background: rgba(40, 167, 69, 0.3);
            border: 2px solid #28a745;
        }
        
        .status.disconnected {
            background: rgba(220, 53, 69, 0.3);
            border: 2px solid #dc3545;
        }
        
        .commentary-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .commentary-entry {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        
        .commentary-entry .timestamp {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .commentary-entry .text {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .commentary-entry .metadata {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }
        
        .audio-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .audio-controls h3 {
            margin-top: 0;
        }
        
        #audioPlayer {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèí NHL Audio Stream Client</h1>
            <p>Real-time hockey commentary powered by Google ADK Audio Agent</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" value="ws://localhost:8765" placeholder="WebSocket URL">
            </div>
            <div class="control-group">
                <label for="connectBtn">&nbsp;</label>
                <button id="connectBtn" class="btn btn-primary">Connect</button>
            </div>
            <div class="control-group">
                <label for="disconnectBtn">&nbsp;</label>
                <button id="disconnectBtn" class="btn btn-danger" disabled>Disconnect</button>
            </div>
        </div>
        
        <div id="status" class="status disconnected">
            üî¥ Disconnected
        </div>
        
        <div class="audio-controls">
            <h3>üéµ Audio Controls</h3>
            <div class="controls">
                <div class="control-group">
                    <label for="testText">Test Commentary:</label>
                    <input type="text" id="testText" 
                           placeholder="Enter commentary text to convert to speech..."
                           value="Connor McDavid speeds down the ice and scores an incredible goal!">
                </div>
                <div class="control-group">
                    <label for="sendTestBtn">&nbsp;</label>
                    <button id="sendTestBtn" class="btn btn-secondary" disabled>Generate Audio</button>
                </div>
            </div>
            <audio id="audioPlayer" controls style="display: none;">
                Your browser does not support the audio element.
            </audio>
        </div>
        
        <div class="commentary-log" id="commentaryLog">
            <div class="commentary-entry">
                <div class="timestamp">Waiting for connection...</div>
                <div class="text">Connect to the Audio Agent to start receiving live commentary audio.</div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Connection Status</h3>
                <div class="value" id="connectionStatus">‚ùå</div>
            </div>
            <div class="stat-card">
                <h3>Messages Received</h3>
                <div class="value" id="messagesReceived">0</div>
            </div>
            <div class="stat-card">
                <h3>Audio Streams</h3>
                <div class="value" id="audioStreams">0</div>
            </div>
            <div class="stat-card">
                <h3>Voice Model</h3>
                <div class="value" id="voiceModel">-</div>
            </div>
        </div>
    </div>

    <script>
        class NHLAudioClient {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.messageCount = 0;
                this.audioCount = 0;
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('sendTestBtn').addEventListener('click', () => this.sendTestAudio());
                
                // Enter key for test audio
                document.getElementById('testText').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && this.isConnected) {
                        this.sendTestAudio();
                    }
                });
            }
            
            connect() {
                const url = document.getElementById('serverUrl').value;
                
                try {
                    this.socket = new WebSocket(url);
                    
                    this.socket.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        this.log('‚úÖ Connected to Audio Agent', 'Connection established successfully');
                    };
                    
                    this.socket.onmessage = (event) => {
                        this.handleMessage(JSON.parse(event.data));
                    };
                    
                    this.socket.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        this.log('üîå Disconnected from Audio Agent', 'Connection closed');
                    };
                    
                    this.socket.onerror = (error) => {
                        this.log('‚ùå Connection Error', `Failed to connect: ${error.message || 'Unknown error'}`);
                        this.updateConnectionStatus(false);
                    };
                    
                } catch (error) {
                    this.log('‚ùå Connection Failed', `Invalid URL or connection error: ${error.message}`);
                }
            }
            
            disconnect() {
                if (this.socket) {
                    this.socket.close();
                    this.socket = null;
                }
                this.isConnected = false;
                this.updateConnectionStatus(false);
            }
            
            handleMessage(data) {
                this.messageCount++;
                document.getElementById('messagesReceived').textContent = this.messageCount;
                
                switch (data.type) {
                    case 'connection':
                        this.log('üéôÔ∏è Audio Agent Ready', data.message);
                        document.getElementById('voiceModel').textContent = data.voice || 'Unknown';
                        break;
                        
                    case 'audio_stream':
                        this.handleAudioStream(data);
                        break;
                        
                    case 'audio_result':
                        this.handleAudioResult(data);
                        break;
                        
                    case 'status':
                        this.handleStatusUpdate(data);
                        break;
                        
                    case 'pong':
                        // Heartbeat response
                        break;
                        
                    default:
                        this.log('üì® Message Received', JSON.stringify(data, null, 2));
                }
            }
            
            handleAudioStream(data) {
                this.audioCount++;
                document.getElementById('audioStreams').textContent = this.audioCount;
                
                // Log the commentary
                this.log('üéµ Live Audio Stream', data.text, {
                    timestamp: data.timestamp,
                    encoding: data.encoding,
                    metadata: data.metadata
                });
                
                // Play the audio
                this.playAudio(data.audio_data, data.encoding);
            }
            
            handleAudioResult(data) {
                const result = data.result;
                if (result.success) {
                    this.log('‚úÖ Audio Generated', `Processing completed in ${result.processing_time_seconds.toFixed(2)}s`, {
                        audio_size: `${result.audio_length_bytes} bytes`,
                        text_length: `${result.text_length} chars`,
                        clients: result.connected_clients
                    });
                } else {
                    this.log('‚ùå Audio Generation Failed', result.error);
                }
            }
            
            handleStatusUpdate(data) {
                this.log('üìä Agent Status', `${data.connected_clients} clients, Queue: ${data.queue_size}`, {
                    voice: data.voice,
                    encoding: data.encoding,
                    streaming: data.is_streaming
                });
            }
            
            sendTestAudio() {
                if (!this.isConnected) {
                    alert('Please connect to the server first');
                    return;
                }
                
                const text = document.getElementById('testText').value.trim();
                if (!text) {
                    alert('Please enter some commentary text');
                    return;
                }
                
                const message = {
                    type: 'request_audio',
                    text: text,
                    metadata: {
                        source: 'web_client',
                        timestamp: new Date().toISOString(),
                        test: true
                    }
                };
                
                this.socket.send(JSON.stringify(message));
                this.log('üì§ Sent Audio Request', text);
            }
            
            playAudio(audioData, encoding) {
                try {
                    // Decode base64 audio data
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    // Create blob and URL
                    const mimeType = encoding === 'MP3' ? 'audio/mpeg' : 
                                   encoding === 'OGG_OPUS' ? 'audio/ogg' : 'audio/wav';
                    const blob = new Blob([bytes], { type: mimeType });
                    const audioUrl = URL.createObjectURL(blob);
                    
                    // Play audio
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    audioPlayer.play().catch(error => {
                        console.error('Audio playback failed:', error);
                        this.log('‚ö†Ô∏è Audio Playback Failed', error.message);
                    });
                    
                    // Clean up URL after playing
                    audioPlayer.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                } catch (error) {
                    console.error('Audio processing failed:', error);
                    this.log('‚ùå Audio Processing Failed', error.message);
                }
            }
            
            updateConnectionStatus(connected) {
                const status = document.getElementById('status');
                const connectionStatus = document.getElementById('connectionStatus');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                const sendTestBtn = document.getElementById('sendTestBtn');
                
                if (connected) {
                    status.className = 'status connected';
                    status.textContent = 'üü¢ Connected to Audio Agent';
                    connectionStatus.textContent = '‚úÖ';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendTestBtn.disabled = false;
                } else {
                    status.className = 'status disconnected';
                    status.textContent = 'üî¥ Disconnected';
                    connectionStatus.textContent = '‚ùå';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendTestBtn.disabled = true;
                }
            }
            
            log(title, message, metadata = null) {
                const logContainer = document.getElementById('commentaryLog');
                const entry = document.createElement('div');
                entry.className = 'commentary-entry';
                
                const timestamp = new Date().toLocaleTimeString();
                const metadataText = metadata ? 
                    Object.entries(metadata).map(([k, v]) => `${k}: ${v}`).join(', ') : '';
                
                entry.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div class="text">${title}: ${message}</div>
                    ${metadataText ? `<div class="metadata">${metadataText}</div>` : ''}
                `;
                
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 50 entries
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
            
            // Send periodic ping to keep connection alive
            startHeartbeat() {
                setInterval(() => {
                    if (this.isConnected && this.socket) {
                        this.socket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // 30 seconds
            }
        }
        
        // Initialize client when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const client = new NHLAudioClient();
            client.startHeartbeat();
        });
    </script>
</body>
</html> 